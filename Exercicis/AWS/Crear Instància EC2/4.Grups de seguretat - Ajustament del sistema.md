# Verificació de grups de seguretat

En l’[activitat anterior](https://github.com/projecteinf/ASO/blob/main/Exercicis/AWS/Crear%20Inst%C3%A0ncia%20EC2/3.Assignaci%C3%B3%20de%20permisos.md), es verifica que:

1. Existeix un *Security Group* per a cada servei.  

1. El nom del *Security Group* coincideix amb el nom del servei.  

   L’única excepció és el servei `ssh`, que utilitza el grup `default`.  

1. Cada *Security Group* té oberts els ports definits pel servei.

---

## Temes pendents

En aquest exercici cal ampliar el script per resoldre els següents punts:

1. El fitxer `configPorts.conf` s’ha d’emmagatzemar amb la resta d’arxius de configuració del sistema.

    * Cal verificar que el fitxer existeix. Si no existeix, s’ha de mostrar un missatge d’error.

1. Cal registrar totes les operacions que fa el script.

1. Poden existir *Security Groups* que ja no formen part de la configuració actual. 

    * Cal verificar que només existeixen els grups definits a `configPorts.conf` (excepte el grup `default`).

1. Cal assegurar que els ports definits a `configPorts.conf` són els únics que estan oberts per a cada grup.

   * Els ports són numèrics.

   * El protocol (TCP o UDP) està especificat al fitxer.

1. El sistema és ineficient si un mateix servei apareix més d’una vegada al fitxer de configuració.

---

## Ubicació del fitxer `configPorts.conf`

1. El fitxer `configPorts.conf` estarà ubicat en una carpeta `security`, juntament amb la resta d’arxius de configuració del sistema.  

1. L’accés al fitxer estarà restringit a l’usuari `root`.  

---

## Accés al fitxer `configPorts.conf`

Si l’usuari no té accés al fitxer:

1. Es mostrarà un missatge d’error per pantalla.  

1. Es registrarà la fallada d’execució del script indicant l’usuari que l’ha executat.  

---

## Registre d’operacions

* El fitxer de registre `grups.log` estarà ubicat en la carpeta `security`.  

* Només hi tindrà accés l’usuari `root`.  

* Es registraran les següents operacions:

  * Execució del script.  

  * Creació de *Security Groups*.  

  * Obertura o tancament de ports.  

  * Eliminació de grups.  

  * Execució sense canvis (sistema correcte).  

### Format del registre

```
Data:[ERR|INF|WAR]:usuari:acció
```

* `ERR`: error
* `INF`: informació
* `WAR`: avís

---

### Rotació del fitxer de registre

Quan `grups.log` superi 1 MB:

1. Es crearà un nou fitxer comprimit.  

1. Els fitxers antics es numeraran de forma incremental:  

```
grups.log
grups.log.1.gz
grups.log.2.gz
```

(`grups.log.1.gz` és el més antic)

---

## Eliminació de grups de seguretat

Un *Security Group* només pot ser eliminat si no està associat a cap instància.

1. Cal eliminar el grup.  

2. Cal registrar l’operació d’eliminació.  

3. No cal registrar individualment el tancament de les regles associades.  

---

## Eliminació de ports

Si un *Security Group* té ports oberts que no apareixen a `configPorts.conf`:

1. Cal eliminar aquestes regles.  

2. Cal registrar l’operació.  

---

## Verificació de dades

Si un servei apareix més d’una vegada al fitxer:

1. Les operacions associades a aquest servei només s’executaran una vegada.  

1. Si el servei ja ha estat processat, el script passarà al següent.

